ARG ASYSTEM_TELEGRAF_VERSION="latest"

# DEFINED: [/asystem/.env_fab](https://github.com/ggear/asystem/blob/master/.env_fab)
FROM telegraf:${ASYSTEM_TELEGRAF_VERSION} AS image_upstream

# DEFINED: [/asystem/.env_fab](https://github.com/ggear/asystem/blob/master/.env_fab)
ARG ASYSTEM_PYTHON_VERSION

FROM image_upstream AS image_base
# INFO: Generated by ./docker_deps.sh, itself generated by a fab pull
USER root
RUN \
    DEBIAN_FRONTEND=noninteractive apt-get update && \
    apt-get -y --no-install-recommends --allow-downgrades install bash=5.2.15-2+b9 && \
    apt-get -y --no-install-recommends --allow-downgrades install less=590-2.1~deb12u2 && \
    apt-get -y --no-install-recommends --allow-downgrades install vim=2:9.0.1378-2+deb12u2 && \
    apt-get -y --no-install-recommends --allow-downgrades install mosquitto-clients=2.0.11-1.2+deb12u2 && \
    apt-get -y --no-install-recommends --allow-downgrades install build-essential=12.9 && \
    apt-get -y --no-install-recommends --allow-downgrades install libbz2-dev=1.0.8-5+b1 && \
    apt-get -y --no-install-recommends --allow-downgrades install libffi-dev=3.4.4-1 && \
    apt-get -y --no-install-recommends --allow-downgrades install zlib1g-dev=1:1.2.13.dfsg-1 && \
    apt-get -y --no-install-recommends --allow-downgrades install libssl-dev=3.0.17-1~deb12u3 && \
    apt-get clean && rm -rf /var/lib/apt/lists/* && \
    mkdir -p /asystem/bin && mkdir -p /asystem/etc && mkdir -p /asystem/mnt
COPY src/main/python/. /asystem/bin/python
COPY target/package/main/resources/image/. /asystem/etc

FROM image_base AS image_build
RUN \
    cd /tmp && \
    rm -f Python* && \
    wget https://www.python.org/ftp/python/$ASYSTEM_PYTHON_VERSION/Python-$ASYSTEM_PYTHON_VERSION.tgz && \
    tar zxf Python-$ASYSTEM_PYTHON_VERSION.tgz && \
    cd /tmp/Python-$ASYSTEM_PYTHON_VERSION && \
    ./configure --prefix=/usr/local && \
    make && \
    make install && \
    cd /root && \
    python3 --version && \
    pip3 --version && \
    cat /asystem/bin/python/.py_deps.txt | xargs -n 1 pip3 install --default-timeout=1000 && \
    rm -rf /tmp/*
RUN \
    cp /asystem/etc/telegraf.conf /etc/telegraf/telegraf.conf

FROM image_build AS image_runtime
WORKDIR /asystem/etc
ENTRYPOINT ["/entrypoint.sh"]
CMD ["telegraf"]
