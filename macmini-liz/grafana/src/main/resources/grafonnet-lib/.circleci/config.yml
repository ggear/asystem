version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run:
          name: unit tests
          command: make test
      - run:
          name: api-docs
          command: make gen-api-docs
      - run:
          name: docs
          command: docker run --rm -u $UID -it -p 8000:8000 -v $PWD:/docs squidfunk/mkdocs-material build
      - add_ssh_keys
      - deploy:
          command: |
            if [ "${CIRCLE_BRANCH}" == "master" ]; then
              cd site
              git init .
              git add .
              git config --global user.email "${USER}@circleci.com"
              git config --global user.name "${USER}"
              git commit -m 'autogenerated docs'
              git push -f "git@github.com:${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}" HEAD:gh-pages
            fi
